#!/usr/bin/perl

use strict;

#parse command line options
use Getopt::Long;
my %opt = (
	'class'      => undef,
	'domain'     => '',
	'loglevel'   => 0,
	'trackers'   => [],
	'threaded'   => 1,
	'mountopts'  => [],
	'mountpoint' => undef,
);
my $resp = GetOptions(
	'class=s'     => \$opt{'class'},
	'domain=s'    => \$opt{'domain'},
	'mountopt=s@' => \$opt{'mountopts'},
	'threaded!'   => \$opt{'threaded'},
	'tracker=s@'  => \$opt{'trackers'},
	'verbose+'    => \$opt{'loglevel'},
);
$opt{'mountpoint'} = shift @ARGV if(@ARGV);

#turn mountopts into a comma-separated list for Fuse
$opt{'mountopts'} = join(',', @{$opt{'mountopts'}});

#process any comma-separated trackers specified and set a default tracker if none were specified
@{$opt{'trackers'}} = split(/,/, join(',', @{$opt{'trackers'}}));
push @{$opt{'trackers'}}, '127.0.0.1:7001' if(!@{$opt{'trackers'}});

#output usage if script was called incorrectly
if(!$resp || !defined($opt{'mountpoint'})) {
	exit;
}

#load threads only if threads are supported by the current perl
if($opt{'threaded'}) {
	require Config;
	require threads if($Config::Config{'useithreads'});
}

#load MogileFS::Fuse and mount the file system
require MogileFS::Fuse::FilePaths;
MogileFS::Fuse::FilePaths->new(%opt)->mount();
